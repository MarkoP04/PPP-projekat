unit Ideja_u;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, FMX.StdCtrls,
  FMX.Controls.Presentation, FMX.Edit, FMX.Layouts, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client;

type
  TForm2 = class(TForm)
    ScrollBox1: TScrollBox;
    Edit1: TEdit;
    Edit2: TEdit;
    Button1: TButton;
    Button2: TButton;
    Button3: TButton;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Button4: TButton;
    procedure LoadButtons;
    procedure ButtonClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
  private
  public
  end;

var
  Form2: TForm2;

implementation

{$R *.fmx}

uses
Program_u;

procedure TForm2.LoadButtons;
var
  Btn: TButton;
  I: Integer;
begin

  for I := ScrollBox1.ControlsCount - 1 downto 0 do
    if ScrollBox1.Controls[I] is TButton then
      ScrollBox1.Controls[I].Free;

  Form1.FDQuery1.Close;
  Form1.FDQuery1.SQL.Text := 'SELECT ideja_id, ime_ideje FROM Ideje';
  Form1.FDQuery1.Open;

  I := 0;
  while not Form1.FDQuery1.Eof do
  begin
    Btn := TButton.Create(Self);
    Btn.Parent := ScrollBox1;

    Btn.Text := Form1.FDQuery1.FieldByName('ime_ideje').AsString;

    Btn.Position.Y := I * 35;
    Btn.Position.X := 10;
    Btn.Width := ScrollBox1.Width - 20;
    Btn.Height := 30;
    Btn.Tag := Form1.FDQuery1.FieldByName('ideja_id').AsInteger;

    Btn.OnClick := ButtonClick;

    Inc(I);
    Form1.FDQuery1.Next;
  end;
end;


procedure TForm2.Button1Click(Sender: TObject);
begin
  Form2.Free;
end;

procedure TForm2.Button2Click(Sender: TObject);
begin
  Form1.FDQuery1.Close;
  Form1.FDQuery1.SQL.Text := 'UPDATE Ideje SET ideja = :pIdeja WHERE ideja_id = :pID';

  Form1.FDQuery1.ParamByName('pIdeja').AsString := Edit1.Text;
  Form1.FDQuery1.ParamByName('pID').AsInteger := StrToInt(Label2.Text);

  try
    Form1.FDQuery1.ExecSQL;
    LoadButtons;
    ShowMessage('Ideja je uspesno promenjena.');
  except
    on E: Exception do
      ShowMessage('Error: ' + E.Message);
  end;
end;

procedure TForm2.Button3Click(Sender: TObject);
begin
  Form1.FDQueryAction.Close;
  Form1.FDQueryAction.SQL.Text :=
    'INSERT INTO Ideje (ime_ideje, ideja) VALUES (:pIme, :pIdeja)';

  Form1.FDQueryAction.ParamByName('pIme').AsString := Edit2.Text;
  Form1.FDQueryAction.ParamByName('pIdeja').AsString := Edit1.Text;

  try
    Form1.FDQueryAction.ExecSQL;
    ShowMessage('Ideja je uspesno dodata.');
    LoadButtons;
  except
    on E: Exception do
      ShowMessage('Error: ' + E.Message);
  end;
end;


procedure TForm2.Button4Click(Sender: TObject);
begin
  Form1.FDQueryAction.Close;
  Form1.FDQueryAction.SQL.Text := 'DELETE FROM Ideje WHERE ideja_id = pID';

  Form1.FDQueryAction.ParamByName('pID').AsInteger := StrToInt(Label2.Text);

  try
    Form1.FDQueryAction.ExecSQL;
    ShowMessage('Ideja je uspesno obrisana.');
    LoadButtons;
  except
    on E: Exception do
      ShowMessage('Error: ' + E.Message);
  end;
end;

procedure TForm2.ButtonClick(Sender: TObject);
var
  Btn: TButton;
begin
  Btn := Sender as TButton;
  Label2.Text := IntToStr(Btn.Tag);
  Label1.Text := Btn.Text;

  Form1.FDQuery1.SQL.Text := 'SELECT ideja FROM Ideje WHERE ideja_id = :id';
  Form1.FDQuery1.ParamByName('id').AsInteger := Btn.Tag;
  Form1.FDQuery1.Open;

  Edit1.Text := Form1.FDQuery1.FieldByName('ideja').AsString;
end;

end.
